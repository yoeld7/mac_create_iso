name: Build Latest macOS ISO

on:
  workflow_dispatch:

jobs:
  build-macos-iso:
    runs-on: macos-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install certifi

      - name: Get latest macOS version and name
        id: macos
        run: |
          JSON=$(curl -s https://gdmf.apple.com/v2/pmv)
          VERSION=$(echo "$JSON" | /usr/bin/plutil -extract PublicAssetSets.macOS xml1 -o - - | grep -m1 '<string>' | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
          NAME=$(echo "$JSON" | /usr/bin/plutil -extract PublicAssetSets.macOS xml1 -o - - | grep -A1 '<string>' | tail -n1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
          SAFE_NAME=$(echo "$NAME" | tr -c '[:alnum:]' '_')
          FULL_NAME="${SAFE_NAME}_${VERSION}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "FULL_NAME=$FULL_NAME" >> $GITHUB_ENV

      - name: Get SWCDN installer URL
        id: swcdn
        run: |
          MAJOR=$(echo ${{ env.VERSION }} | cut -d. -f1)
          CATALOG_URL="https://swcatalog.apple.com/content/catalogs/others/index-${MAJOR}.sucatalog.gz"
          curl -sL "$CATALOG_URL" -o catalog.gz
          python3 <<'PYCODE'
          import gzip, plistlib, os, sys
          
          version = os.environ["VERSION"]
          
          with gzip.open("catalog.gz", "rb") as f:
              catalog = plistlib.load(f)
          
          url = None
          for p in catalog["Products"].values():
              meta = p.get("ExtendedMetaInfo", {})
              if meta.get("ProductName", "").startswith("macOS") and meta.get("ProductVersion", "").startswith(version):
                  for pkg in p.get("Packages", []):
                      u = pkg.get("URL", "")
                      if "swcdn.apple.com" in u:
                          url = u
                          break
                  if url:
                      break
          
          if not url:
              sys.exit("No SWCDN URL found!")
          
          print(f"url={url}")
          PYCODE
                  shell: bash
                  env:
                    VERSION: ${{ env.VERSION }}
          
                - name: Set installer URL output
                  run: |
                    url=$(python3 - <<'EOF'
          import gzip, plistlib, os, sys
          
          version = os.environ["VERSION"]
          
          with gzip.open("catalog.gz", "rb") as f:
              catalog = plistlib.load(f)
          
          url = None
          for p in catalog["Products"].values():
              meta = p.get("ExtendedMetaInfo", {})
              if meta.get("ProductName", "").startswith("macOS") and meta.get("ProductVersion", "").startswith(version):
                  for pkg in p.get("Packages", []):
                      u = pkg.get("URL", "")
                      if "swcdn.apple.com" in u:
                          url = u
                          break
                  if url:
                      break
          
          if not url:
              sys.exit("No SWCDN URL found!")
          
          print(url)
          EOF
          )
                    echo "INSTALL_URL=$url" >> $GITHUB_ENV
                  env:
                    VERSION: ${{ env.VERSION }}

      - name: Download macOS InstallAssistant
        run: |
          echo "Downloading ${{ env.FULL_NAME }}..."
          curl -L -o ~/InstallAssistant.pkg "${{ env.INSTALL_URL }}"

      - name: Install InstallAssistant.app
        run: |
          sudo installer -pkg ~/InstallAssistant.pkg -target /

      - name: Create bootable ISO
        run: |
          APP_PATH=$(ls -d /Applications/Install\ macOS* || true)
          if [ -z "$APP_PATH" ]; then
            echo "âŒ InstallAssistant not found under /Applications"
            exit 1
          fi

          ISO_NAME="${FULL_NAME}.iso"
          WORKDIR=$(mktemp -d)

          echo "Creating DMG workspace..."
          hdiutil create -o "$WORKDIR/install_macOS" -size 16000m -volname install_macOS -layout SPUD -fs HFS+J

          echo "Mounting DMG..."
          hdiutil attach "$WORKDIR/install_macOS.dmg" -mountpoint /Volumes/install_macOS

          echo "Creating bootable media..."
          sudo "$APP_PATH/Contents/Resources/createinstallmedia" --volume /Volumes/install_macOS --nointeraction

          echo "Converting to ISO..."
          hdiutil convert "$WORKDIR/install_macOS.dmg" -format UDTO -o "$WORKDIR/$ISO_NAME"
          mv "$WORKDIR/$ISO_NAME.cdr" "$WORKDIR/$ISO_NAME"

          echo "ISO created: $WORKDIR/$ISO_NAME"
          echo "ISO_PATH=$WORKDIR/$ISO_NAME" >> $GITHUB_ENV
        env:
          FULL_NAME: ${{ env.FULL_NAME }}

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FULL_NAME }}
          path: ${{ env.ISO_PATH }}

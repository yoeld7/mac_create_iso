name: Build Latest macOS ISO

on:
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install aria2

      - name: Clone gibMacOS
        run: |
          git clone https://github.com/corpnewt/gibMacOS.git
          chmod +x gibMacOS/gibMacOS.command

      - name: Parse latest macOS product ID
        shell: bash
        run: |
          cd gibMacOS
          python3 gibMacOS.py -r > catalog.txt
          echo "Catalog preview:"
          head -n 20 catalog.txt
          PRODUCT=$(grep -B1 "InstallAssistantAuto" catalog.txt | head -n 1 | awk '{print $1}')
          echo "Detected latest product ID: $PRODUCT"
          echo "PRODUCT_ID=$PRODUCT" >> $GITHUB_ENV

      - name: Download latest macOS installer
        run: |
          cd gibMacOS
          python3 gibMacOS.py -p "$PRODUCT_ID" -d

      - name: Locate InstallAssistant.pkg
        run: |
          INSTALLER=$(find gibMacOS/macOS\ Downloads/publicrelease/ -name "InstallAssistant.pkg" | sort | tail -n 1)
          echo "INSTALLER_PATH=$INSTALLER" >> $GITHUB_ENV

      - name: Extract macOS Installer
        run: |
          mkdir -p ~/macOSISO
          pkgutil --expand "$INSTALLER_PATH" ~/macOSISO/expanded
          cd ~/macOSISO/expanded
          tar -xf Payload
          mv "Install macOS"*.app /Applications/

      - name: Create disk image
        run: |
          hdiutil create -o ~/macOSISO/macOSInstaller -size 16000m -volname macOSInstaller -layout SPUD -fs HFS+

      - name: Mount disk image
        run: |
          hdiutil attach ~/macOSISO/macOSInstaller.dmg -noverify -mountpoint /Volumes/macOSInstaller

      - name: Create bootable installer
        run: |
          sudo /Applications/Install\ macOS*.app/Contents/Resources/createinstallmedia --volume /Volumes/macOSInstaller --nointeraction

      - name: Convert to ISO
        run: |
          hdiutil detach /Volumes/macOSInstaller
          hdiutil convert ~/macOSISO/macOSInstaller.dmg -format UDTO -o ~/macOSISO/macOSInstaller.iso
          mv ~/macOSISO/macOSInstaller.iso.cdr ~/macOSISO/macOSInstaller.iso

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: macOSInstaller.iso
          path: ~/macOSISO/macOSInstaller.iso

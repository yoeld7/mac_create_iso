name: Build macOS ISO with Mist CLI

on:
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install aria2

      - name: Download Mist CLI binary
        run: |
          curl -L -o mist https://github.com/ninxsoft/mist/releases/latest/download/mist-cli-macos-arm64
          chmod +x mist
          sudo mv mist /usr/local/bin/mist

      - name: Download latest macOS installer using Mist
        run: |
          mkdir -p ~/macOSISO
          mist download --latest --output ~/macOSISO

      - name: Expand InstallAssistant.pkg
        run: |
          INSTALLER=$(find ~/macOSISO -name "InstallAssistant.pkg" | sort | tail -n 1)
          pkgutil --expand "$INSTALLER" ~/macOSISO/expanded
          cd ~/macOSISO/expanded
          tar -xf Payload
          mv "Install macOS"*.app /Applications/

      - name: Create disk image
        run: |
          hdiutil create -o ~/macOSISO/macOSInstaller -size 16000m -volname macOSInstaller -layout SPUD -fs HFS+

      - name: Mount disk image
        run: |
          hdiutil attach ~/macOSISO/macOSInstaller.dmg -noverify -mountpoint /Volumes/macOSInstaller

      - name: Create bootable installer
        run: |
          sudo /Applications/Install\ macOS*.app/Contents/Resources/createinstallmedia --volume /Volumes/macOSInstaller --nointeraction

      - name: Convert to ISO
        run: |
          hdiutil detach /Volumes/macOSInstaller
          hdiutil convert ~/macOSISO/macOSInstaller.dmg -format UDTO -o ~/macOSISO/macOSInstaller.iso
          mv ~/macOSISO/macOSInstaller.iso.cdr ~/macOSISO/macOSInstaller.iso

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: macOSInstaller.iso
          path: ~/macOSISO/macOSInstaller.iso

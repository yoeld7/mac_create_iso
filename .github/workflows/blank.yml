name: Build Latest macOS ISO

on:
  workflow_dispatch:

jobs:
  build-macos-iso:
    runs-on: macos-latest
    steps:
      - name: Get latest macOS info and URL
        id: macos
        run: |
          # Fetch latest macOS list from Apple
          JSON=$(curl -s https://gdmf.apple.com/v2/pmv)

          # Extract latest public macOS version and marketing name
          VERSION=$(echo "$JSON" | /usr/bin/plutil -extract PublicAssetSets.macOS xml1 -o - - | grep -m1 '<string>' | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
          NAME=$(echo "$JSON" | /usr/bin/plutil -extract PublicAssetSets.macOS xml1 -o - - | grep -A1 '<string>' | tail -n1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/')

          # Download the SWCatalog and extract installer URL
          MAJOR=$(echo $VERSION | cut -d. -f1)
          CATALOG_URL="https://swcatalog.apple.com/content/catalogs/others/index-${MAJOR}.sucatalog.gz"
          URL=$(curl -sL "$CATALOG_URL" | gzip -d | plutil -extract Products xml1 -o - - | grep -m1 'swcdn.apple.com' | sed 's/.*<string>\(.*\)<\/string>.*/\1/')

          # Sanitize name for filenames
          SAFE_NAME=$(echo "$NAME" | tr -c '[:alnum:]' '_')
          FULL_NAME="${SAFE_NAME}_${VERSION}"

          # Export to GitHub environment variables
          echo "URL=$URL" >> $GITHUB_ENV
          echo "FULL_NAME=$FULL_NAME" >> $GITHUB_ENV

      - name: Download macOS InstallAssistant
        run: |
          echo "Downloading ${{ env.FULL_NAME }}..."
          curl -L -o ~/InstallAssistant.pkg "$URL"

      - name: Install InstallAssistant.app
        run: |
          echo "Installing package..."
          sudo installer -pkg ~/InstallAssistant.pkg -target /

      - name: Create bootable ISO
        run: |
          APP_PATH=$(ls -d /Applications/Install\ macOS* || true)
          if [ -z "$APP_PATH" ]; then
            echo "âŒ InstallAssistant not found under /Applications"
            exit 1
          fi

          ISO_NAME="${FULL_NAME}.iso"
          WORKDIR=$(mktemp -d)

          echo "Creating DMG workspace..."
          hdiutil create -o "$WORKDIR/install_macOS" -size 16000m -volname install_macOS -layout SPUD -fs HFS+J

          echo "Mounting DMG..."
          hdiutil attach "$WORKDIR/install_macOS.dmg" -mountpoint /Volumes/install_macOS

          echo "Creating bootable media..."
          sudo "$APP_PATH/Contents/Resources/createinstallmedia" --volume /Volumes/install_macOS --nointeraction

          echo "Converting to ISO..."
          hdiutil convert "$WORKDIR/install_macOS.dmg" -format UDTO -o "$WORKDIR/$ISO_NAME"
          mv "$WORKDIR/$ISO_NAME.cdr" "$WORKDIR/$ISO_NAME"

          echo "ISO created: $WORKDIR/$ISO_NAME"
          echo "ISO_PATH=$WORKDIR/$ISO_NAME" >> $GITHUB_ENV

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FULL_NAME }}
          path: ${{ env.ISO_PATH }}

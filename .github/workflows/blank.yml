name: Create macOS ISO

on:
  workflow_dispatch:

jobs:
  create-iso:
    runs-on: macos-latest  # Use a self-hosted macOS runner
    steps:
      - name: Get latest macOS version name
        id: get_version
        run: |
          latest_version=$(softwareupdate --list-full-installers | \
            grep -Eo 'macOS [A-Za-z]+ [0-9]+\.[0-9]+' | \
            sort -V | tail -n 1)
          echo "Latest macOS version: $latest_version"
          echo "version_name=$latest_version" >> $GITHUB_OUTPUT

      - name: Download macOS installer
        run: |
          version="${{ steps.get_version.outputs.version_name }}"
          echo "Downloading installer for $version"
          # This command downloads the full installer to /Applications
          softwareupdate --fetch-full-installer --full-installer-version "$version"

      - name: Create ISO using createinstallmedia
        run: |
          INSTALLER_PATH="/Applications/Install macOS*.app"
          ISO_NAME="macOS-${{ steps.get_version.outputs.version_name }}.iso"
          WORKDIR="$HOME/macOS-ISO"
          mkdir -p "$WORKDIR"
          hdiutil create -o "$WORKDIR/macOS.cdr" -size 16000m -layout SPUD -fs HFS+J
          hdiutil attach "$WORKDIR/macOS.cdr.dmg" -noverify -mountpoint /Volumes/install_build
          sudo "$INSTALLER_PATH/Contents/Resources/createinstallmedia" \
            --volume /Volumes/install_build --nointeraction
          hdiutil detach /Volumes/Install\ macOS*
          hdiutil convert "$WORKDIR/macOS.cdr.dmg" -format UDTO -o "$WORKDIR/$ISO_NAME"
          mv "$WORKDIR/$ISO_NAME.cdr" "$WORKDIR/$ISO_NAME"
          echo "ISO created at $WORKDIR/$ISO_NAME"

name: Build macOS ISO with installinstallmacos.py

on:
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install aria2
          pip3 install xattr

      - name: Download installinstallmacos.py
        run: |
          curl -O https://raw.githubusercontent.com/munki/macadmin-scripts/main/installinstallmacos.py
          chmod +x installinstallmacos.py

      - name: Download latest macOS installer
        run: |
          mkdir -p ~/macOSISO
          ./installinstallmacos.py --latest --output-dir ~/macOSISO

      - name: Expand InstallAssistant.pkg
        run: |
          INSTALLER=$(find ~/macOSISO -name "InstallAssistant.pkg" | sort | tail -n 1)
          pkgutil --expand "$INSTALLER" ~/macOSISO/expanded
          cd ~/macOSISO/expanded
          tar -xf Payload
          mv "Install macOS"*.app /Applications/

      - name: Create disk image
        run: |
          hdiutil create -o ~/macOSISO/macOSInstaller -size 16000m -volname macOSInstaller -layout SPUD -fs HFS+

      - name: Mount disk image
        run: |
          hdiutil attach ~/macOSISO/macOSInstaller.dmg -noverify -mountpoint /Volumes/macOSInstaller

      - name: Create bootable installer
        run: |
          sudo /Applications/Install\ macOS*.app/Contents/Resources/createinstallmedia --volume /Volumes/macOSInstaller --nointeraction

      - name: Convert to ISO
        run: |
          hdiutil detach /Volumes/macOSInstaller
          hdiutil

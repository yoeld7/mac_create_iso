name: Build Latest macOS ISO

on:
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install aria2

      - name: Fetch latest InstallAssistant.pkg URL
        run: |
          curl -O https://swscan.apple.com/content/catalogs/others/index-13-12-11-10.15-10.14-10.13-10.12-10.11-10.10-10.9-mountainlion-lion-snowleopard-leopard.merged-1.sucatalog.gz
          gunzip index-*.gz
          URL=$(grep -Eo 'https://[^"]+InstallAssistant\.pkg' index-* | sort | tail -n 1)
          echo "Latest InstallAssistant.pkg URL: $URL"
          echo "INSTALLER_URL=$URL" >> $GITHUB_ENV

      - name: Download InstallAssistant.pkg
        run: |
          mkdir -p ~/macOSISO
          aria2c -x 16 -s 16 -d ~/macOSISO "$INSTALLER_URL"

      - name: Extract macOS Installer
        run: |
          cd ~/macOSISO
          pkgutil --expand InstallAssistant.pkg expanded
          cd expanded
          tar -xf Payload
          mv "Install macOS"*.app /Applications/

      - name: Create disk image
        run: |
          hdiutil create -o ~/macOSISO/macOSInstaller -size 16000m -volname macOSInstaller -layout SPUD -fs HFS+

      - name: Mount disk image
        run: |
          hdiutil attach ~/macOSISO/macOSInstaller.dmg -noverify -mountpoint /Volumes/macOSInstaller

      - name: Run createinstallmedia
        run: |
          sudo /Applications/Install\ macOS*.app/Contents/Resources/createinstallmedia --volume /Volumes/macOSInstaller --nointeraction

      - name: Convert to ISO
        run: |
          hdiutil detach /Volumes/macOSInstaller
          hdiutil convert ~/macOSISO/macOSInstaller.dmg -format UDTO -o ~/macOSISO/macOSInstaller.iso
          mv ~/macOSISO/macOSInstaller.iso.cdr ~/macOSISO/macOSInstaller.iso

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: macOSInstaller.iso
          path: ~/macOSISO/macOSInstaller.iso

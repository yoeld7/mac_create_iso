name: Create macOS ISO

on:
  workflow_dispatch:

jobs:
  create-iso:
    runs-on: macos-latest  # Requires a self-hosted macOS runner
    steps:
      - name: Free up disk space
        run: |
          # Remove large, unused packages
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /Library/Android
          
          # Remove cached tools and user caches
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf "$HOME/.cache"
          
          # Remove Xcode to free ~10–15GB
          sudo rm -rf /Applications/Xcode.app
          
          # Clean temporary files
          sudo rm -rf /tmp/*
          
          df -h
      - name: Get latest macOS version
        id: get_version
        run: |
          echo "Scanning for available macOS installers..."
          latest_version=$(softwareupdate --list-full-installers | \
            grep -Eo '[0-9]+\.[0-9]+(\.[0-9]+)?' | \
            sort -V | tail -n 1)
          if [ -z "$latest_version" ]; then
            echo "No macOS installer version found."
            exit 1
          fi
          echo "Latest macOS version: $latest_version"
          echo "version=$latest_version" >> $GITHUB_OUTPUT

      - name: Download macOS installer
        run: |
          version="${{ steps.get_version.outputs.version }}"
          echo "Attempting to download installer for macOS $version..."
          softwareupdate --fetch-full-installer --full-installer-version "$version" || {
            echo "Installer for $version not found. Trying fallback..."
            softwareupdate --fetch-full-installer
          }

      - name: Create ISO using createinstallmedia
        run: |
          INSTALLER_PATH=$(ls /Applications | grep -i 'Install macOS' | head -n 1)
          if [ -z "$INSTALLER_PATH" ]; then
            echo "Installer app not found in /Applications."
            exit 1
          fi
          ISO_NAME="macOS-${{ steps.get_version.outputs.version }}.iso"
          WORKDIR="$HOME/macOS-ISO"
          mkdir -p "$WORKDIR"
          echo "Creating blank disk image..."
          hdiutil create -o "$WORKDIR/macOS.cdr" -size 18000m -layout SPUD -fs HFS+J
          hdiutil attach "$WORKDIR/macOS.cdr.dmg" -noverify -mountpoint /Volumes/install_build
          echo "Running createinstallmedia..."
          sudo "/Applications/$INSTALLER_PATH/Contents/Resources/createinstallmedia" \
            --volume /Volumes/install_build --nointeraction
          echo "Detaching volume..."
          hdiutil detach /Volumes/Install\ macOS*
          echo "Converting to ISO..."
          hdiutil convert "$WORKDIR/macOS.cdr.dmg" -format UDTO -o "$WORKDIR/$ISO_NAME"
          mv "$WORKDIR/$ISO_NAME.cdr" "$WORKDIR/$ISO_NAME"
          echo "✅ ISO created at $WORKDIR/$ISO_NAME"
    
      - name: Upload ISO as artifact
        uses: actions/upload-artifact@v4
        with:
          name: macOS-ISO-${{ steps.get_version.outputs.version }}
          path: ~/macOS-ISO/macOS-${{ steps.get_version.outputs.version }}.iso
